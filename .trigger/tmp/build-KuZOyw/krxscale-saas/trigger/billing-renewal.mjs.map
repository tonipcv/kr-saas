{
  "version": 3,
  "sources": ["../../../../../trigger/billing-renewal.ts"],
  "sourcesContent": ["import { schedules, tasks } from \"@trigger.dev/sdk/v3\";\nimport { prisma } from \"@/lib/prisma\";\n\nexport const dailyBillingRenewal = schedules.task({\n  id: \"daily-billing-renewal\",\n  cron: {\n    pattern: \"0 9 * * *\", // 09:00 todos os dias\n    timezone: \"America/Sao_Paulo\",\n  },\n  run: async () => {\n    const now = new Date();\n    const yyyymm = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, \"0\")}`;\n\n    console.log(\"[SCHEDULER] Starting billing renewal\", {\n      timestamp: now.toISOString(),\n      period: yyyymm,\n    });\n\n    try {\n      // Buscar assinaturas DUE (não-nativas, gerenciadas por nós)\n      const due = await prisma.customerSubscription.findMany({\n        where: {\n          canceledAt: null,\n          isNative: false,\n          status: { in: [\"ACTIVE\", \"PAST_DUE\"] as any },\n          currentPeriodEnd: { lte: now },\n        },\n        select: {\n          id: true,\n          provider: true,\n          customerId: true,\n          merchantId: true,\n        },\n        take: 200,\n        orderBy: { currentPeriodEnd: \"asc\" },\n      });\n\n      // Include KRXPAY as alias for Pagar.me prepaid subscriptions\n      const pagarme = due.filter((s) => [\"PAGARME\", \"KRXPAY\"].includes(String(s.provider)) as any);\n      const appmax = due.filter((s) => s.provider === (\"APPMAX\" as any));\n\n      const summary = {\n        pagarme: { queued: 0, failed: 0 },\n        appmax: { queued: 0, failed: 0 },\n      };\n\n      // Disparar Pagar.me Prepaid\n      if (process.env.TRIGGER_ENABLE_PAGARME_PREPAID === \"true\") {\n        for (const sub of pagarme) {\n          try {\n            await tasks.trigger(\"pagarme-prepaid-renewal\", {\n              subscriptionId: sub.id,\n            });\n            summary.pagarme.queued++;\n          } catch (e) {\n            console.error(\"[SCHEDULER] Failed to trigger pagarme-prepaid-renewal\", {\n              subscriptionId: sub.id,\n              error: (e as any)?.message,\n            });\n            summary.pagarme.failed++;\n          }\n        }\n      } else {\n        console.log(\"[SCHEDULER] Skipped Pagar.me prepaid (feature flag disabled)\");\n      }\n\n      // Disparar Appmax\n      if (process.env.TRIGGER_ENABLE_APPMAX === \"true\") {\n        for (const sub of appmax) {\n          try {\n            await tasks.trigger(\"appmax-renewal\", {\n              subscriptionId: sub.id,\n            });\n            summary.appmax.queued++;\n          } catch (e) {\n            console.error(\"[SCHEDULER] Failed to trigger appmax-renewal\", {\n              subscriptionId: sub.id,\n              error: (e as any)?.message,\n            });\n            summary.appmax.failed++;\n          }\n        }\n      } else {\n        console.log(\"[SCHEDULER] Skipped Appmax (feature flag disabled)\");\n      }\n\n      console.log(\"[SCHEDULER] Summary\", summary);\n      return { period: yyyymm, ...summary };\n    } catch (error) {\n      console.error(\"[SCHEDULER] ❌ Error while scheduling renewals\", error);\n      throw error;\n    }\n  },\n});\n"],
  "mappings": ";;;;;;;;;;;;;;AAAA;AAGO,IAAM,sBAAsB,kBAAU,KAAK;AAAA,EAChD,IAAI;AAAA,EACJ,MAAM;AAAA,IACJ,SAAS;AAAA;AAAA,IACT,UAAU;AAAA,EACZ;AAAA,EACA,KAAK,mCAAY;AACf,UAAM,MAAM,oBAAI,KAAK;AACrB,UAAM,SAAS,GAAG,IAAI,YAAY,CAAC,GAAG,OAAO,IAAI,SAAS,IAAI,CAAC,EAAE,SAAS,GAAG,GAAG,CAAC;AAEjF,YAAQ,IAAI,wCAAwC;AAAA,MAClD,WAAW,IAAI,YAAY;AAAA,MAC3B,QAAQ;AAAA,IACV,CAAC;AAED,QAAI;AAEF,YAAM,MAAM,MAAM,OAAO,qBAAqB,SAAS;AAAA,QACrD,OAAO;AAAA,UACL,YAAY;AAAA,UACZ,UAAU;AAAA,UACV,QAAQ,EAAE,IAAI,CAAC,UAAU,UAAU,EAAS;AAAA,UAC5C,kBAAkB,EAAE,KAAK,IAAI;AAAA,QAC/B;AAAA,QACA,QAAQ;AAAA,UACN,IAAI;AAAA,UACJ,UAAU;AAAA,UACV,YAAY;AAAA,UACZ,YAAY;AAAA,QACd;AAAA,QACA,MAAM;AAAA,QACN,SAAS,EAAE,kBAAkB,MAAM;AAAA,MACrC,CAAC;AAGD,YAAM,UAAU,IAAI,OAAO,CAAC,MAAM,CAAC,WAAW,QAAQ,EAAE,SAAS,OAAO,EAAE,QAAQ,CAAC,CAAQ;AAC3F,YAAM,SAAS,IAAI,OAAO,CAAC,MAAM,EAAE,aAAc,QAAgB;AAEjE,YAAM,UAAU;AAAA,QACd,SAAS,EAAE,QAAQ,GAAG,QAAQ,EAAE;AAAA,QAChC,QAAQ,EAAE,QAAQ,GAAG,QAAQ,EAAE;AAAA,MACjC;AAGA,UAAI,QAAQ,IAAI,mCAAmC,QAAQ;AACzD,mBAAW,OAAO,SAAS;AACzB,cAAI;AACF,kBAAM,MAAM,QAAQ,2BAA2B;AAAA,cAC7C,gBAAgB,IAAI;AAAA,YACtB,CAAC;AACD,oBAAQ,QAAQ;AAAA,UAClB,SAAS,GAAG;AACV,oBAAQ,MAAM,yDAAyD;AAAA,cACrE,gBAAgB,IAAI;AAAA,cACpB,OAAQ,GAAW;AAAA,YACrB,CAAC;AACD,oBAAQ,QAAQ;AAAA,UAClB;AAAA,QACF;AAAA,MACF,OAAO;AACL,gBAAQ,IAAI,8DAA8D;AAAA,MAC5E;AAGA,UAAI,QAAQ,IAAI,0BAA0B,QAAQ;AAChD,mBAAW,OAAO,QAAQ;AACxB,cAAI;AACF,kBAAM,MAAM,QAAQ,kBAAkB;AAAA,cACpC,gBAAgB,IAAI;AAAA,YACtB,CAAC;AACD,oBAAQ,OAAO;AAAA,UACjB,SAAS,GAAG;AACV,oBAAQ,MAAM,gDAAgD;AAAA,cAC5D,gBAAgB,IAAI;AAAA,cACpB,OAAQ,GAAW;AAAA,YACrB,CAAC;AACD,oBAAQ,OAAO;AAAA,UACjB;AAAA,QACF;AAAA,MACF,OAAO;AACL,gBAAQ,IAAI,oDAAoD;AAAA,MAClE;AAEA,cAAQ,IAAI,uBAAuB,OAAO;AAC1C,aAAO,EAAE,QAAQ,QAAQ,GAAG,QAAQ;AAAA,IACtC,SAAS,OAAO;AACd,cAAQ,MAAM,iDAAiD,KAAK;AACpE,YAAM;AAAA,IACR;AAAA,EACF,GAnFK;AAoFP,CAAC;",
  "names": []
}
