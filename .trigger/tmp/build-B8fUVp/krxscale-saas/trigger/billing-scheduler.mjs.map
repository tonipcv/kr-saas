{
  "version": 3,
  "sources": ["../../../../../trigger/billing-scheduler.ts"],
  "sourcesContent": ["import { schedules } from \"@trigger.dev/sdk/v3\";\nimport { prisma } from \"@/lib/prisma\";\n\nexport const billingScheduler = schedules.task({\n  id: \"billing-scheduler-dry-run\",\n  cron: \"0 * * * *\",\n  run: async (payload) => {\n    const now = new Date();\n    console.log(\"üîç Billing Scheduler - DRY RUN MODE\", { now: now.toISOString() });\n\n    try {\n      // Stripe (native-managed) - observe only\n      const stripeTotal = await prisma.customerSubscription.count({ where: { provider: \"STRIPE\" } });\n      console.log(`‚úÖ Stripe Native: ${stripeTotal} active (auto-renewal)`);\n\n      // Pagar.me native (provider-managed) - observe only\n      const pagarmeNative = await prisma.customerSubscription.count({\n        where: { provider: \"PAGARME\", isNative: true },\n      });\n      console.log(`‚úÖ Pagar.me Native: ${pagarmeNative} active (auto-renewal)`);\n\n      // Pagar.me prepaid (manual renewal)\n      const pagarmePrepaidDue = await prisma.customerSubscription.findMany({\n        where: {\n          provider: \"PAGARME\",\n          isNative: false,\n          canceledAt: null,\n          currentPeriodEnd: { lte: now },\n        },\n        select: { id: true, currentPeriodEnd: true, priceCents: true },\n        take: 100,\n        orderBy: { currentPeriodEnd: \"asc\" },\n      });\n      console.log(`‚ö†Ô∏è  Pagar.me Prepaid DUE: ${pagarmePrepaidDue.length}`);\n      if (pagarmePrepaidDue.length > 0) {\n        console.log(\"[DRY RUN] Pagar.me prepaid subscriptions that would be renewed:\");\n        pagarmePrepaidDue.forEach((sub, idx) => {\n          const dueDate = sub.currentPeriodEnd ? sub.currentPeriodEnd.toISOString() : \"N/A\";\n          console.log(`  ${idx + 1}. ${sub.id} - Due: ${dueDate} - Amount: ${sub.priceCents / 100}`);\n        });\n      }\n\n      // Appmax (manual renewal)\n      const appmaxDue = await prisma.customerSubscription.findMany({\n        where: {\n          provider: \"APPMAX\",\n          canceledAt: null,\n          currentPeriodEnd: { lte: now },\n        },\n        select: { id: true, currentPeriodEnd: true, priceCents: true },\n        take: 100,\n        orderBy: { currentPeriodEnd: \"asc\" },\n      });\n      console.log(`‚ö†Ô∏è  Appmax DUE: ${appmaxDue.length}`);\n      if (appmaxDue.length > 0) {\n        console.log(\"[DRY RUN] Appmax subscriptions that would be renewed:\");\n        appmaxDue.forEach((sub, idx) => {\n          const dueDate = sub.currentPeriodEnd ? sub.currentPeriodEnd.toISOString() : \"N/A\";\n          console.log(`  ${idx + 1}. ${sub.id} - Due: ${dueDate} - Amount: ${sub.priceCents / 100}`);\n        });\n      }\n\n      console.log(\"‚úÖ Scheduler completed successfully\");\n\n      return {\n        mode: \"DRY_RUN\",\n        timestamp: now.toISOString(),\n        summary: {\n          stripeNative: { count: stripeTotal, action: \"observe\" },\n          pagarmeNative: { count: pagarmeNative, action: \"observe\" },\n          pagarmePrepaidDue: { count: pagarmePrepaidDue.length, action: \"would_renew\" },\n          appmaxDue: { count: appmaxDue.length, action: \"would_renew\" },\n        },\n      };\n    } catch (error) {\n      console.error(\"‚ùå Scheduler error:\", error);\n      throw error;\n    }\n  },\n});\n"],
  "mappings": ";;;;;;;;;;;;;AAAA;AAGO,IAAM,mBAAmB,kBAAU,KAAK;AAAA,EAC7C,IAAI;AAAA,EACJ,MAAM;AAAA,EACN,KAAK,8BAAO,YAAY;AACtB,UAAM,MAAM,oBAAI,KAAK;AACrB,YAAQ,IAAI,uCAAuC,EAAE,KAAK,IAAI,YAAY,EAAE,CAAC;AAE7E,QAAI;AAEF,YAAM,cAAc,MAAM,OAAO,qBAAqB,MAAM,EAAE,OAAO,EAAE,UAAU,SAAS,EAAE,CAAC;AAC7F,cAAQ,IAAI,oBAAoB,WAAW,wBAAwB;AAGnE,YAAM,gBAAgB,MAAM,OAAO,qBAAqB,MAAM;AAAA,QAC5D,OAAO,EAAE,UAAU,WAAW,UAAU,KAAK;AAAA,MAC/C,CAAC;AACD,cAAQ,IAAI,sBAAsB,aAAa,wBAAwB;AAGvE,YAAM,oBAAoB,MAAM,OAAO,qBAAqB,SAAS;AAAA,QACnE,OAAO;AAAA,UACL,UAAU;AAAA,UACV,UAAU;AAAA,UACV,YAAY;AAAA,UACZ,kBAAkB,EAAE,KAAK,IAAI;AAAA,QAC/B;AAAA,QACA,QAAQ,EAAE,IAAI,MAAM,kBAAkB,MAAM,YAAY,KAAK;AAAA,QAC7D,MAAM;AAAA,QACN,SAAS,EAAE,kBAAkB,MAAM;AAAA,MACrC,CAAC;AACD,cAAQ,IAAI,6BAA6B,kBAAkB,MAAM,EAAE;AACnE,UAAI,kBAAkB,SAAS,GAAG;AAChC,gBAAQ,IAAI,iEAAiE;AAC7E,0BAAkB,QAAQ,CAAC,KAAK,QAAQ;AACtC,gBAAM,UAAU,IAAI,mBAAmB,IAAI,iBAAiB,YAAY,IAAI;AAC5E,kBAAQ,IAAI,KAAK,MAAM,CAAC,KAAK,IAAI,EAAE,WAAW,OAAO,cAAc,IAAI,aAAa,GAAG,EAAE;AAAA,QAC3F,CAAC;AAAA,MACH;AAGA,YAAM,YAAY,MAAM,OAAO,qBAAqB,SAAS;AAAA,QAC3D,OAAO;AAAA,UACL,UAAU;AAAA,UACV,YAAY;AAAA,UACZ,kBAAkB,EAAE,KAAK,IAAI;AAAA,QAC/B;AAAA,QACA,QAAQ,EAAE,IAAI,MAAM,kBAAkB,MAAM,YAAY,KAAK;AAAA,QAC7D,MAAM;AAAA,QACN,SAAS,EAAE,kBAAkB,MAAM;AAAA,MACrC,CAAC;AACD,cAAQ,IAAI,mBAAmB,UAAU,MAAM,EAAE;AACjD,UAAI,UAAU,SAAS,GAAG;AACxB,gBAAQ,IAAI,uDAAuD;AACnE,kBAAU,QAAQ,CAAC,KAAK,QAAQ;AAC9B,gBAAM,UAAU,IAAI,mBAAmB,IAAI,iBAAiB,YAAY,IAAI;AAC5E,kBAAQ,IAAI,KAAK,MAAM,CAAC,KAAK,IAAI,EAAE,WAAW,OAAO,cAAc,IAAI,aAAa,GAAG,EAAE;AAAA,QAC3F,CAAC;AAAA,MACH;AAEA,cAAQ,IAAI,oCAAoC;AAEhD,aAAO;AAAA,QACL,MAAM;AAAA,QACN,WAAW,IAAI,YAAY;AAAA,QAC3B,SAAS;AAAA,UACP,cAAc,EAAE,OAAO,aAAa,QAAQ,UAAU;AAAA,UACtD,eAAe,EAAE,OAAO,eAAe,QAAQ,UAAU;AAAA,UACzD,mBAAmB,EAAE,OAAO,kBAAkB,QAAQ,QAAQ,cAAc;AAAA,UAC5E,WAAW,EAAE,OAAO,UAAU,QAAQ,QAAQ,cAAc;AAAA,QAC9D;AAAA,MACF;AAAA,IACF,SAAS,OAAO;AACd,cAAQ,MAAM,sBAAsB,KAAK;AACzC,YAAM;AAAA,IACR;AAAA,EACF,GAxEK;AAyEP,CAAC;",
  "names": []
}
