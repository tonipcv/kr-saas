{
  "version": 3,
  "sources": ["../../../../../trigger/check-stuck-deliveries.ts"],
  "sourcesContent": ["import { schedules, tasks } from \"@trigger.dev/sdk/v3\";\nimport { prisma } from \"@/lib/prisma\";\nimport type { deliverWebhook } from \"./deliver-webhook\";\n\n/**\n * Safety net: Re-dispara deliveries PENDING travadas\n * \n * Cenários cobertos:\n * - Trigger.dev estava indisponível quando emitOutboundEvent() foi chamado\n * - Job falhou de forma inesperada sem atualizar o DB\n * - Deliveries antigas que nunca foram processadas\n * \n * Roda a cada 5 minutos em produção\n */\nexport const checkStuckDeliveries = schedules.task({\n  id: \"check-stuck-deliveries\",\n  \n  // A cada 5 minutos (apenas em produção)\n  cron: {\n    pattern: \"*/5 * * * *\",\n    timezone: \"America/Sao_Paulo\",\n    environments: [\"PRODUCTION\"], // Não rodar em dev/staging\n  },\n  \n  run: async (payload) => {\n    console.log(\"[Safety Net] Checking for stuck webhook deliveries\", {\n      timestamp: payload.timestamp,\n    });\n\n    try {\n      // Buscar deliveries PENDING há mais de 10 minutos\n      // que não foram atualizadas recentemente (stuck)\n      const tenMinutesAgo = new Date(Date.now() - 10 * 60 * 1000);\n      \n      const stuckDeliveries = await prisma.outboundWebhookDelivery.findMany({\n        where: {\n          status: 'PENDING',\n          createdAt: { lt: tenMinutesAgo },\n          updatedAt: { lt: tenMinutesAgo },\n          // Apenas deliveries que deveriam ter sido processadas\n          nextAttemptAt: { lte: new Date() },\n        },\n        select: {\n          id: true,\n          attempts: true,\n          createdAt: true,\n          updatedAt: true,\n          endpointId: true,\n        },\n        take: 50, // Limitar para não sobrecarregar\n        orderBy: { createdAt: 'asc' },\n      });\n\n      if (stuckDeliveries.length === 0) {\n        console.log(\"[Safety Net] No stuck deliveries found ✅\");\n        return {\n          checked: true,\n          stuck: 0,\n          retriggered: 0,\n          failed: 0,\n        };\n      }\n\n      console.log(`[Safety Net] Found ${stuckDeliveries.length} stuck deliveries`);\n\n      let retriggered = 0;\n      let failed = 0;\n\n      // Re-disparar jobs para deliveries travadas\n      for (const delivery of stuckDeliveries) {\n        try {\n          // Verificar se não ultrapassou max attempts (10)\n          if ((delivery.attempts || 0) >= 10) {\n            console.log(`[Safety Net] Delivery ${delivery.id} exceeded max attempts, marking as FAILED`);\n            \n            await prisma.outboundWebhookDelivery.update({\n              where: { id: delivery.id },\n              data: {\n                status: 'FAILED',\n                lastError: 'Exceeded maximum retry attempts (safety net)',\n                nextAttemptAt: null,\n              },\n            });\n            \n            failed++;\n            continue;\n          }\n\n          // Re-disparar job\n          await tasks.trigger<typeof deliverWebhook>(\n            \"deliver-webhook\",\n            { deliveryId: delivery.id },\n            {\n              idempotencyKey: `${delivery.id}-retry-${Date.now()}`, // Novo idempotency key para forçar re-execução\n              queue: 'webhooks', // Queue name\n            }\n          );\n\n          console.log(`[Safety Net] Re-triggered delivery ${delivery.id} (attempt ${delivery.attempts || 0})`);\n          retriggered++;\n\n        } catch (error) {\n          console.error(`[Safety Net] Failed to re-trigger delivery ${delivery.id}:`, error);\n          failed++;\n        }\n      }\n\n      console.log(`[Safety Net] Summary: ${retriggered} retriggered, ${failed} failed`);\n\n      return {\n        checked: true,\n        stuck: stuckDeliveries.length,\n        retriggered,\n        failed,\n      };\n\n    } catch (error) {\n      console.error(\"[Safety Net] Error checking stuck deliveries:\", error);\n      throw error;\n    }\n  },\n});\n"],
  "mappings": ";;;;;;;;;;;;;;AAAA;AAcO,IAAM,uBAAuB,kBAAU,KAAK;AAAA,EACjD,IAAI;AAAA;AAAA,EAGJ,MAAM;AAAA,IACJ,SAAS;AAAA,IACT,UAAU;AAAA,IACV,cAAc,CAAC,YAAY;AAAA;AAAA,EAC7B;AAAA,EAEA,KAAK,8BAAO,YAAY;AACtB,YAAQ,IAAI,sDAAsD;AAAA,MAChE,WAAW,QAAQ;AAAA,IACrB,CAAC;AAED,QAAI;AAGF,YAAM,gBAAgB,IAAI,KAAK,KAAK,IAAI,IAAI,KAAK,KAAK,GAAI;AAE1D,YAAM,kBAAkB,MAAM,OAAO,wBAAwB,SAAS;AAAA,QACpE,OAAO;AAAA,UACL,QAAQ;AAAA,UACR,WAAW,EAAE,IAAI,cAAc;AAAA,UAC/B,WAAW,EAAE,IAAI,cAAc;AAAA;AAAA,UAE/B,eAAe,EAAE,KAAK,oBAAI,KAAK,EAAE;AAAA,QACnC;AAAA,QACA,QAAQ;AAAA,UACN,IAAI;AAAA,UACJ,UAAU;AAAA,UACV,WAAW;AAAA,UACX,WAAW;AAAA,UACX,YAAY;AAAA,QACd;AAAA,QACA,MAAM;AAAA;AAAA,QACN,SAAS,EAAE,WAAW,MAAM;AAAA,MAC9B,CAAC;AAED,UAAI,gBAAgB,WAAW,GAAG;AAChC,gBAAQ,IAAI,0CAA0C;AACtD,eAAO;AAAA,UACL,SAAS;AAAA,UACT,OAAO;AAAA,UACP,aAAa;AAAA,UACb,QAAQ;AAAA,QACV;AAAA,MACF;AAEA,cAAQ,IAAI,sBAAsB,gBAAgB,MAAM,mBAAmB;AAE3E,UAAI,cAAc;AAClB,UAAI,SAAS;AAGb,iBAAW,YAAY,iBAAiB;AACtC,YAAI;AAEF,eAAK,SAAS,YAAY,MAAM,IAAI;AAClC,oBAAQ,IAAI,yBAAyB,SAAS,EAAE,2CAA2C;AAE3F,kBAAM,OAAO,wBAAwB,OAAO;AAAA,cAC1C,OAAO,EAAE,IAAI,SAAS,GAAG;AAAA,cACzB,MAAM;AAAA,gBACJ,QAAQ;AAAA,gBACR,WAAW;AAAA,gBACX,eAAe;AAAA,cACjB;AAAA,YACF,CAAC;AAED;AACA;AAAA,UACF;AAGA,gBAAM,MAAM;AAAA,YACV;AAAA,YACA,EAAE,YAAY,SAAS,GAAG;AAAA,YAC1B;AAAA,cACE,gBAAgB,GAAG,SAAS,EAAE,UAAU,KAAK,IAAI,CAAC;AAAA;AAAA,cAClD,OAAO;AAAA;AAAA,YACT;AAAA,UACF;AAEA,kBAAQ,IAAI,sCAAsC,SAAS,EAAE,aAAa,SAAS,YAAY,CAAC,GAAG;AACnG;AAAA,QAEF,SAAS,OAAO;AACd,kBAAQ,MAAM,8CAA8C,SAAS,EAAE,KAAK,KAAK;AACjF;AAAA,QACF;AAAA,MACF;AAEA,cAAQ,IAAI,yBAAyB,WAAW,iBAAiB,MAAM,SAAS;AAEhF,aAAO;AAAA,QACL,SAAS;AAAA,QACT,OAAO,gBAAgB;AAAA,QACvB;AAAA,QACA;AAAA,MACF;AAAA,IAEF,SAAS,OAAO;AACd,cAAQ,MAAM,iDAAiD,KAAK;AACpE,YAAM;AAAA,IACR;AAAA,EACF,GAhGK;AAiGP,CAAC;",
  "names": []
}
