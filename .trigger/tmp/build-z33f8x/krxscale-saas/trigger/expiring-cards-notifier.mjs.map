{
  "version": 3,
  "sources": ["../../../../../trigger/expiring-cards-notifier.ts"],
  "sourcesContent": ["import { schedules } from \"@trigger.dev/sdk/v3\";\nimport { prisma } from \"@/lib/prisma\";\n\nexport const expiringCardsNotifier = schedules.task({\n  id: \"expiring-cards-notifier\",\n  cron: {\n    pattern: \"0 10 * * 1\", // Segunda-feira 10:00\n    timezone: \"America/Sao_Paulo\",\n  },\n  run: async () => {\n    const now = new Date();\n    const currentYear = now.getUTCFullYear();\n    const currentMonth = now.getUTCMonth() + 1; // 1-12\n    const nextMonth = currentMonth === 12 ? 1 : currentMonth + 1;\n    const nextMonthYear = currentMonth === 12 ? currentYear + 1 : currentYear;\n\n    console.log(\"[NOTIFIER] Checking expiring cards\", {\n      currentYear,\n      currentMonth,\n      nextMonth,\n      nextMonthYear,\n    });\n\n    const expiringSoon = await prisma.customerPaymentMethod.findMany({\n      where: {\n        status: \"ACTIVE\" as any,\n        isDefault: true,\n        OR: [\n          { expYear: currentYear, expMonth: currentMonth },\n          { expYear: nextMonthYear, expMonth: nextMonth },\n        ],\n      },\n      include: { customer: true },\n      take: 500,\n      orderBy: { updatedAt: \"desc\" },\n    });\n\n    let planned = 0;\n    for (const method of expiringSoon) {\n      const email = (method as any).customer?.email || \"unknown\";\n      const name = (method as any).customer?.name || \"\";\n\n      // No email sender available in the repo; log intent for observability.\n      console.log(\"[NOTIFIER] Would send email\", {\n        to: email,\n        name,\n        brand: method.brand,\n        last4: method.last4,\n        expMonth: method.expMonth,\n        expYear: method.expYear,\n        updateUrl: `${process.env.NEXT_PUBLIC_APP_URL || \"\"}/billing/cards`,\n      });\n      planned++;\n    }\n\n    console.log(`[NOTIFIER] Expiring cards planned notifications: ${planned}/${expiringSoon.length}`);\n\n    return { total: expiringSoon.length, planned };\n  },\n});\n"],
  "mappings": ";;;;;;;;;;;AAAA;AAGO,IAAM,wBAAwB,kBAAU,KAAK;AAAA,EAClD,IAAI;AAAA,EACJ,MAAM;AAAA,IACJ,SAAS;AAAA;AAAA,IACT,UAAU;AAAA,EACZ;AAAA,EACA,KAAK,mCAAY;AACf,UAAM,MAAM,oBAAI,KAAK;AACrB,UAAM,cAAc,IAAI,eAAe;AACvC,UAAM,eAAe,IAAI,YAAY,IAAI;AACzC,UAAM,YAAY,iBAAiB,KAAK,IAAI,eAAe;AAC3D,UAAM,gBAAgB,iBAAiB,KAAK,cAAc,IAAI;AAE9D,YAAQ,IAAI,sCAAsC;AAAA,MAChD;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACF,CAAC;AAED,UAAM,eAAe,MAAM,OAAO,sBAAsB,SAAS;AAAA,MAC/D,OAAO;AAAA,QACL,QAAQ;AAAA,QACR,WAAW;AAAA,QACX,IAAI;AAAA,UACF,EAAE,SAAS,aAAa,UAAU,aAAa;AAAA,UAC/C,EAAE,SAAS,eAAe,UAAU,UAAU;AAAA,QAChD;AAAA,MACF;AAAA,MACA,SAAS,EAAE,UAAU,KAAK;AAAA,MAC1B,MAAM;AAAA,MACN,SAAS,EAAE,WAAW,OAAO;AAAA,IAC/B,CAAC;AAED,QAAI,UAAU;AACd,eAAW,UAAU,cAAc;AACjC,YAAM,QAAS,OAAe,UAAU,SAAS;AACjD,YAAM,OAAQ,OAAe,UAAU,QAAQ;AAG/C,cAAQ,IAAI,+BAA+B;AAAA,QACzC,IAAI;AAAA,QACJ;AAAA,QACA,OAAO,OAAO;AAAA,QACd,OAAO,OAAO;AAAA,QACd,UAAU,OAAO;AAAA,QACjB,SAAS,OAAO;AAAA,QAChB,WAAW,GAAG,QAAQ,IAAI,uBAAuB,EAAE;AAAA,MACrD,CAAC;AACD;AAAA,IACF;AAEA,YAAQ,IAAI,oDAAoD,OAAO,IAAI,aAAa,MAAM,EAAE;AAEhG,WAAO,EAAE,OAAO,aAAa,QAAQ,QAAQ;AAAA,EAC/C,GAjDK;AAkDP,CAAC;",
  "names": []
}
